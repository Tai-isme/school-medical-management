import React, { useEffect, useState } from "react";
import { Button, Card, Row, Col, Tag, Modal, Descriptions, Form, Input, DatePicker, message } from "antd";
import { PlusOutlined } from "@ant-design/icons";
import axios from "axios";
import dayjs from "dayjs";

const VaccineProgramList = () => {
  const [programs, setPrograms] = useState([]); // ƒë·ªïi th√†nh m·∫£ng
  const [detailVisible, setDetailVisible] = useState(false);
  const [createVisible, setCreateVisible] = useState(false);
  const [loading, setLoading] = useState(false);
  const [program, setProgram] = useState(null); // ch∆∞∆°ng tr√¨nh ƒëang xem chi ti·∫øt

  useEffect(() => {
    fetchProgram();
  }, []);

  const fetchProgram = async () => {
    const token = localStorage.getItem("token");
    try {
      const res = await axios.get(
        "http://localhost:8080/api/admin/vaccine-program", // API tr·∫£ v·ªÅ danh s√°ch
        {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        }
      );
      setPrograms(res.data); // l∆∞u m·∫£ng ch∆∞∆°ng tr√¨nh
    } catch (error) {
      setPrograms([]);
    }
  };

  const handleCreate = async (values) => {
    setLoading(true);
    const token = localStorage.getItem("token");
    try {
      await axios.post(
        "http://localhost:8080/api/admin/vaccine-program",
        {
          vaccineName: values.vaccineName,
          manufacture: values.manufacture,
          description: values.description,
          vaccineDate: values.vaccineDate.format("YYYY-MM-DD"),
          note: values.note,
        },
        {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        }
      );
      message.success("T·∫°o ch∆∞∆°ng tr√¨nh ti√™m ch·ªßng th√†nh c√¥ng!");
      setCreateVisible(false);
      fetchProgram();
    } catch (error) {
      message.error("T·∫°o ch∆∞∆°ng tr√¨nh ti√™m ch·ªßng th·∫•t b·∫°i!");
    } finally {
      setLoading(false);
    }
  };

  if (!programs.length) return <div>ƒêang t·∫£i...</div>;

  return (
    <div style={{ padding: 24, marginLeft: 220, transition: "margin 0.2s", maxWidth: "100vw" }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
        <h2 style={{ margin: 0 }}>
          <span style={{ color: "#52c41a", marginRight: 8 }}>üõ°Ô∏è</span>
          Qu·∫£n L√Ω Ch∆∞∆°ng Tr√¨nh Ti√™m Ch·ªßng
        </h2>
        <Button
          type="primary"
          icon={<PlusOutlined />}
          style={{ background: "#21ba45", border: "none" }}
          onClick={() => setCreateVisible(true)}
        >
          L√™n l·ªãch ti√™m ch·ªßng
        </Button>
      </div>
      {programs.map((program) => (
        <Card
          key={program.vaccineId}
          style={{
            background: "#f6fcf7",
            borderRadius: 10,
            border: "1px solid #e6f4ea",
            width: "calc(100vw - 260px)", // k√©o d√†i h·∫øt b√™n ph·∫£i, tr·ª´ sidebar
            minWidth: 1200, // tƒÉng minWidth n·∫øu mu·ªën
            margin: "0 auto",
            transition: "width 0.2s",
            marginBottom: 16,
          }}
          bodyStyle={{ padding: 24 }}
        >
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
            <div>
              <div style={{ fontWeight: 700, fontSize: 18, marginBottom: 4 }}>{program.vaccineName}</div>
              <div style={{ color: "#555", marginBottom: 2 }}>
                M√¥ t·∫£: {program.description}
              </div>
              <div style={{ color: "#555", marginBottom: 8 }}>
                Ng√†y ti√™m: {program.vaccineDate}
              </div>
            </div>
            <Tag color="blue" style={{ fontSize: 14, marginTop: 4 }}>{program.status}</Tag>
          </div>
          <Row gutter={32} style={{ margin: "24px 0" }}>
            <Col span={12}>
              <div style={{ background: "#fff", borderRadius: 8, padding: 16, textAlign: "center" }}>
                <div style={{ color: "#1890ff", fontWeight: 700, fontSize: 32 }}>{program.totalStudents}</div>
                <div style={{ color: "#888", fontWeight: 500 }}>T·ªïng h·ªçc sinh</div>
              </div>
            </Col>
            <Col span={12}>
              <div style={{ background: "#fff", borderRadius: 8, padding: 16, textAlign: "center" }}>
                <div style={{ color: "#21ba45", fontWeight: 700, fontSize: 32 }}>{program.confirmed}</div>
                <div style={{ color: "#888", fontWeight: 500 }}>ƒê√£ x√°c nh·∫≠n</div>
              </div>
            </Col>
          </Row>
          <div style={{ display: "flex", gap: 12 }}>
            <Button onClick={() => {
              setDetailVisible(true);
              setProgram(program); // set ch∆∞∆°ng tr√¨nh ƒëang xem chi ti·∫øt
            }}>
              Xem chi ti·∫øt
            </Button>
            <Button type="primary" style={{ background: "#21ba45", border: "none" }}>
              G·ª≠i th√¥ng b√°o
            </Button>
          </div>
        </Card>
      ))}
      <Modal
        title="Chi ti·∫øt ch∆∞∆°ng tr√¨nh ti√™m ch·ªßng"
        open={detailVisible}
        onCancel={() => setDetailVisible(false)}
        footer={[
          <Button key="close" onClick={() => setDetailVisible(false)}>
            ƒê√≥ng
          </Button>,
        ]}
      >
        {program && (
          <Descriptions column={1} bordered size="small">
            <Descriptions.Item label="Vaccine ID">{program.vaccineId}</Descriptions.Item>
            <Descriptions.Item label="T√™n vaccine">{program.vaccineName}</Descriptions.Item>
            <Descriptions.Item label="M√¥ t·∫£">{program.description}</Descriptions.Item>
            <Descriptions.Item label="Ng√†y ti√™m">{program.vaccineDate}</Descriptions.Item>
            <Descriptions.Item label="Tr·∫°ng th√°i">{program.status}</Descriptions.Item>
            <Descriptions.Item label="Ghi ch√∫">{program.note}</Descriptions.Item>
          </Descriptions>
        )}
      </Modal>
      <Modal
        title="L√™n l·ªãch ti√™m ch·ªßng"
        open={createVisible}
        onCancel={() => setCreateVisible(false)}
        footer={null}
        destroyOnClose
      >
        <Form layout="vertical" onFinish={handleCreate}>
          <Form.Item label="T√™n vaccine" name="vaccineName" rules={[{ required: true, message: "Nh·∫≠p t√™n vaccine" }]}>
            <Input />
          </Form.Item>
          <Form.Item label="Nh√† s·∫£n xu·∫•t" name="manufacture" rules={[{ required: true, message: "Nh·∫≠p nh√† s·∫£n xu·∫•t" }]}>
            <Input />
          </Form.Item>
          <Form.Item label="M√¥ t·∫£" name="description">
            <Input.TextArea rows={2} />
          </Form.Item>
          <Form.Item label="Ng√†y ti√™m" name="vaccineDate" rules={[{ required: true, message: "Ch·ªçn ng√†y ti√™m" }]}>
            <DatePicker style={{ width: "100%" }} format="YYYY-MM-DD" />
          </Form.Item>
          <Form.Item label="Ghi ch√∫" name="note">
            <Input.TextArea rows={2} />
          </Form.Item>
          <Form.Item>
            <Button type="primary" htmlType="submit" loading={loading} style={{ width: "100%" }}>
              T·∫°o ch∆∞∆°ng tr√¨nh
            </Button>
          </Form.Item>
        </Form>
      </Modal>
    </div>
  );
};

export default VaccineProgramList;